<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-Sound Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts for the Tech Theme -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    
    <!-- FFmpeg WASM 0.11.x (Single Threaded Config) -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <!-- JSZip for Batch Archiving -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['JetBrains Mono', 'monospace'],
                        display: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        omni: {
                            dark: '#030712', // Very dark blue/black
                            panel: '#111827',
                            cyan: '#06b6d4',
                            accent: '#22d3ee',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #030712;
            /* Cyberpunk/Tech Grid Background */
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(6, 182, 212, 0.15) 0%, transparent 60%),
                linear-gradient(rgba(34, 211, 238, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(34, 211, 238, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 50px 50px, 50px 50px;
        }

        .glass-panel {
            background: rgba(17, 24, 39, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(34, 211, 238, 0.2);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.1);
        }

        .tech-text-shadow {
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.5);
        }

        /* Scanline effect */
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(34, 211, 238, 0.1);
            animation: scan 6s linear infinite;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes scan {
            0% { top: -5%; opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { top: 105%; opacity: 0; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; 
        }
        ::-webkit-scrollbar-thumb {
            background: #0e7490; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #22d3ee; 
        }

        /* Fix for Dropdown Colors - Ensures high contrast on all browsers */
        select option {
            background-color: #030712;
            color: #22d3ee;
            padding: 8px;
        }
    </style>
</head>
<body class="text-gray-300 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Brand Header -->
    <div class="text-center mb-8 relative z-10">
        <h1 class="font-display text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 tech-text-shadow tracking-widest uppercase mb-2">
            Omni-Sound
        </h1>
        <div class="flex items-center justify-center gap-2 text-cyan-500/80 text-xs md:text-sm tracking-[0.3em] font-bold">
            <span class="w-8 h-[1px] bg-cyan-500/50"></span>
            ADVANCED BATCH PROCESSOR
            <span class="w-8 h-[1px] bg-cyan-500/50"></span>
        </div>
    </div>

    <!-- Main Interface Panel -->
    <div class="glass-panel w-full max-w-xl rounded-xl overflow-hidden relative">
        <!-- Decorative Scanline -->
        <div class="scanline"></div>

        <!-- Top Bar -->
        <div class="bg-black/40 px-6 py-3 border-b border-cyan-500/20 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500/80"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500/80"></div>
                <div class="w-3 h-3 rounded-full bg-green-500/80"></div>
            </div>
            <div class="text-[10px] text-cyan-400 font-mono">SYS.VER.2.6.2 // ROBUST_CORE</div>
        </div>

        <div class="p-8 space-y-8 relative z-20">
            
            <!-- Terminal/Status Log -->
            <div class="space-y-2">
                <label class="text-[10px] uppercase tracking-widest text-cyan-500 font-bold">System Log</label>
                <div id="status" class="bg-black/60 border border-cyan-900/50 rounded p-4 font-mono text-xs text-cyan-300 h-32 overflow-y-auto shadow-inner">
                    <p class="opacity-70">> Initializing Omni-Sound Core...</p>
                    <p class="opacity-70">> Waiting for input stream...</p>
                </div>
            </div>

            <div class="grid gap-6">
                <!-- Input Section -->
                <div class="space-y-2 group">
                    <label class="text-[10px] uppercase tracking-widest text-gray-400 group-hover:text-cyan-400 transition-colors">Source File(s)</label>
                    <div class="relative">
                        <!-- 'multiple' attribute added for batch selection -->
                        <input type="file" id="fileInput" multiple class="block w-full text-sm text-gray-400
                            file:mr-4 file:py-2.5 file:px-6
                            file:rounded-md file:border-0
                            file:text-xs file:font-bold file:tracking-wider
                            file:bg-cyan-900/30 file:text-cyan-400
                            file:border file:border-cyan-500/30
                            file:cursor-pointer
                            hover:file:bg-cyan-500/20 hover:file:text-cyan-300
                            cursor-pointer bg-black/20 rounded-lg border border-gray-700 focus:border-cyan-500/50 focus:outline-none transition-all"
                        />
                    </div>
                    <p class="text-[10px] text-gray-600 pl-1">Input: Any common Audio (MP3, WAV, APE, FLAC, etc.)</p>
                </div>

                <!-- Format Selection -->
                <div class="space-y-2 group">
                    <label class="text-[10px] uppercase tracking-widest text-gray-400 group-hover:text-cyan-400 transition-colors">Target Codec</label>
                    <div class="relative">
                        <!-- Updated Select Class: Solid dark background and Cyan text for readability -->
                        <select id="formatSelect" class="w-full bg-gray-900 border border-gray-700 text-cyan-400 font-bold rounded-lg px-4 py-3 focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/20 appearance-none cursor-pointer hover:bg-gray-800 transition-all font-mono text-sm shadow-lg">
                            <optgroup label="Common Formats">
                                <option value="mp3">MP3 (MPEG Layer III)</option>
                                <option value="wav">WAV (PCM 16-bit)</option>
                                <option value="aac">AAC (Advanced Audio Coding)</option>
                                <option value="ogg">OGG (Vorbis)</option>
                                <option value="flac">FLAC (Lossless)</option>
                                <option value="m4a">M4A (Apple Audio)</option>
                                <option value="opus">Opus (High Efficiency)</option>
                            </optgroup>
                            <optgroup label="Professional / Lossless">
                                <option value="aiff">AIFF (Apple PCM)</option>
                                <option value="alac">ALAC (Apple Lossless)</option>
                                <option value="wavpack">WavPack (.wv)</option>
                                <option value="pcm">PCM (Raw Headerless)</option>
                                <option value="bwf">BWF (Broadcast Wave)</option>
                                <option value="cdda">CDDA (CD Ready 44.1k/16b)</option>
                            </optgroup>
                            <optgroup label="Legacy / Specific">
                                <option value="wma">WMA (Windows Media)</option>
                                <option value="amr">AMR (Voice/8kHz)</option>
                                <option value="tta">TTA (True Audio)</option>
                            </optgroup>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-cyan-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <button id="convertBtn" class="w-full relative group overflow-hidden rounded-lg bg-cyan-900/20 border border-cyan-500/50 p-4 transition-all hover:bg-cyan-500/10 hover:border-cyan-400 hover:shadow-[0_0_20px_rgba(6,182,212,0.3)] disabled:opacity-50 disabled:cursor-not-allowed">
                <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-cyan-500/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></div>
                <div class="flex items-center justify-center gap-3 relative z-10">
                    <span id="btnText" class="font-display font-bold tracking-widest text-cyan-400 group-hover:text-cyan-300 uppercase">Initiate Sequence</span>
                    <svg id="spinner" class="animate-spin h-5 w-5 text-cyan-400 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </button>

            <!-- Download Section -->
            <div id="downloadArea" class="hidden p-4 bg-cyan-900/10 border border-cyan-500/30 rounded-lg text-center animate-[pulse_3s_ease-in-out_infinite]">
                <p id="completionMsg" class="text-cyan-400 text-xs font-bold mb-3 uppercase tracking-wider">Processing Complete</p>
                <a id="downloadLink" href="#" class="inline-block bg-cyan-500 hover:bg-cyan-400 text-black font-bold font-display uppercase tracking-wider py-2 px-8 rounded clip-path-slant transition-colors">
                    Download Data
                </a>
            </div>

            <!-- Footer/Credits -->
            <div class="pt-6 border-t border-gray-800 text-center space-y-1">
                <div class="text-[10px] text-gray-500 tracking-widest uppercase">
                    Architect: <span class="text-cyan-500/80 font-bold">king_of_coding</span>
                </div>
                <div class="text-[10px] text-gray-600 tracking-widest uppercase">
                    Property of <span class="text-gray-400 font-bold">Omni-Science</span> Corporation
                </div>
                <div class="text-[9px] text-gray-700 mt-2">
                    Note: Proprietary encrypted formats (FSB, BNK) require specific decryption keys not present in this web node.
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        
        // --- CORE LOGIC CHANGE: Dynamic Instance Management ---
        // Instead of a single persistent instance, we manage the lifecycle 
        // to handle crashes/exits (common in single-threaded mode) robustly.
        let ffmpeg = null;

        const createInstance = () => {
            return createFFmpeg({ 
                log: false, 
                // Explicitly use Single Threaded Core to avoid SharedArrayBuffer issues
                corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js',
                mainName: 'main'
            });
        };

        // Advanced Codec Configuration Map
        const formatConfig = {
            'mp3': { ext: 'mp3', args: ['-c:a', 'libmp3lame'] },
            'wav': { ext: 'wav', args: ['-c:a', 'pcm_s16le'] },
            'aac': { ext: 'm4a', args: ['-c:a', 'aac'] },
            'ogg': { ext: 'ogg', args: ['-c:a', 'libvorbis'] },
            'flac': { ext: 'flac', args: ['-c:a', 'flac'] },
            'm4a': { ext: 'm4a', args: ['-c:a', 'aac'] }, 
            'opus': { ext: 'opus', args: ['-c:a', 'libopus'] },
            'wma':  { ext: 'wma', args: ['-c:a', 'wmav2'] }, 
            
            // Professional / Specific
            'aiff': { ext: 'aiff', args: ['-c:a', 'pcm_s16be'] }, 
            'alac': { ext: 'm4a', args: ['-c:a', 'alac'] },      
            'wavpack': { ext: 'wv', args: ['-c:a', 'wavpack'] },
            'pcm':  { ext: 'pcm', args: ['-f', 's16le', '-acodec', 'pcm_s16le'] }, 
            'bwf':  { ext: 'wav', args: ['-c:a', 'pcm_s16le', '-metadata', 'bwf_originator=OmniSound'] }, 
            
            // Special Logic
            'cdda': { ext: 'wav', args: ['-c:a', 'pcm_s16le', '-ar', '44100', '-ac', '2'] }, 
            'amr':  { ext: 'amr', args: ['-c:a', 'libopencore_amrnb', '-ar', '8000', '-ac', '1'] }, 
            'tta':  { ext: 'tta', args: ['-c:a', 'tta'] }
        };

        const fileInput = document.getElementById('fileInput');
        const formatSelect = document.getElementById('formatSelect');
        const convertBtn = document.getElementById('convertBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const statusLog = document.getElementById('status');
        const downloadArea = document.getElementById('downloadArea');
        const downloadLink = document.getElementById('downloadLink');
        const completionMsg = document.getElementById('completionMsg');

        const log = (message) => {
            statusLog.classList.remove('hidden');
            const line = document.createElement('p');
            line.className = "border-l-2 border-cyan-500/50 pl-2 my-1";
            line.textContent = `> ${message}`;
            statusLog.appendChild(line);
            statusLog.scrollTop = statusLog.scrollHeight;
        };

        // Helper to ensure FFmpeg is ready
        const ensureFFmpegReady = async () => {
            if (!ffmpeg) {
                ffmpeg = createInstance();
            }
            if (!ffmpeg.isLoaded()) {
                await ffmpeg.load();
                log('Omni-Sound Core: ONLINE');
            }
        };

        // Initial Load
        ensureFFmpegReady().catch(e => {
            log('Initial Load Failed. Will retry on conversion.');
            console.error(e);
        });

        convertBtn.addEventListener('click', async () => {
            const files = fileInput.files;
            if (files.length === 0) {
                alert('ERROR: No source data selected.');
                return;
            }

            convertBtn.disabled = true;
            spinner.classList.remove('hidden');
            downloadArea.classList.add('hidden');
            statusLog.innerHTML = ''; 
            
            const selectedFormatKey = formatSelect.value;
            const config = formatConfig[selectedFormatKey];
            const isBatch = files.length > 1;
            
            let zip = isBatch ? new JSZip() : null;

            log(`Batch Protocol Initiated: ${files.length} file(s) detected.`);

            try {
                for (let i = 0; i < files.length; i++) {
                    // Ensure FFmpeg is alive before every file
                    await ensureFFmpegReady();

                    const file = files[i];
                    const safeName = file.name.replace(/\s+/g, '_').replace(/[()]/g, '');
                    const inputName = `input_${i}_${safeName}`;
                    const outputName = `output_${i}.${config.ext}`;
                    
                    btnText.textContent = `Processing ${i + 1}/${files.length}`;
                    log(`[${i + 1}/${files.length}] Mounting: ${file.name}`);
                    
                    // 1. Write file to memory
                    ffmpeg.FS('writeFile', inputName, await fetchFile(file));

                    // 2. Run conversion with specific args
                    log(`[${i + 1}/${files.length}] Transcoding to ${selectedFormatKey.toUpperCase()}...`);
                    
                    const args = ['-i', inputName, ...config.args, outputName];
                    let needsRestart = false;

                    try {
                        await ffmpeg.run(...args);
                    } catch (e) {
                         // Check for ExitStatus (often effectively "success" or "finished" in single-threaded mode)
                         if (e && (e.name === 'ExitStatus' || (e.message && e.message.includes('exit')))) {
                             log('Core finished process (Exit Code).');
                             // If the core exits, we MUST restart it for the next file
                             needsRestart = true;
                         } else {
                             // Genuine Error
                             throw e;
                         }
                    }

                    // 3. Read result
                    // Even if exit(0) occurred, the file usually exists in MEMFS before the runtime fully dies
                    let data = null;
                    try {
                        data = ffmpeg.FS('readFile', outputName);
                    } catch (readError) {
                        console.error("Read error:", readError);
                        log(`Error: Could not retrieve output for ${file.name}`);
                        continue; // Skip to next file
                    }

                    // 4. Handle Output
                    if (isBatch) {
                        const originalName = file.name.split('.').slice(0, -1).join('.');
                        const newFileName = `${originalName}.${config.ext}`;
                        zip.file(newFileName, data);
                        log(`[${i + 1}/${files.length}] Archived successfully.`);
                    } else {
                        const blob = new Blob([data.buffer], { type: `audio/${config.ext}` });
                        const url = URL.createObjectURL(blob);
                        downloadLink.href = url;
                        const originalName = file.name.split('.').slice(0, -1).join('.');
                        downloadLink.download = `${originalName}_converted.${config.ext}`;
                        downloadLink.textContent = "DOWNLOAD FILE";
                        completionMsg.textContent = "Conversion Complete";
                    }

                    // 5. Cleanup
                    try {
                        ffmpeg.FS('unlink', inputName);
                        ffmpeg.FS('unlink', outputName);
                    } catch(e) {}

                    // 6. Restart Core if tainted
                    if (needsRestart) {
                         log('Resetting Core for next operation...');
                         try { ffmpeg.exit(); } catch(e) {} // Ensure it's dead
                         ffmpeg = null; // Clear reference
                         // The loop will re-create it at the top via ensureFFmpegReady()
                    }
                }

                if (isBatch) {
                    log('Finalizing Data Archive (ZIP)...');
                    btnText.textContent = 'Compressing...';
                    
                    const zipBlob = await zip.generateAsync({type: "blob"});
                    const zipUrl = URL.createObjectURL(zipBlob);
                    
                    downloadLink.href = zipUrl;
                    downloadLink.download = `OmniSound_Batch_${new Date().getTime()}.zip`;
                    downloadLink.textContent = "DOWNLOAD BATCH ZIP";
                    completionMsg.textContent = "Batch Processing Complete";
                    log('Archive generated successfully.');
                } else {
                    log('Sequence Complete. Link generated.');
                }
                
                downloadArea.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                log('FATAL ERROR: Sequence aborted.');
                alert('An error occurred during conversion. Please verify the file format is supported.');
            } finally {
                convertBtn.disabled = false;
                btnText.textContent = 'Initiate Sequence';
                spinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
